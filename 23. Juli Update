---
title: "Racial Disparities in the Criminal Justice System across the United States"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    css: style.css
    theme: default
---
```{r}
#Load Data and Libraries
#install.packages("flexdashboard")
library(flexdashboard)

#install.packages("tidyverse")
library(tidyverse)

theme_set(theme_light())

prison_summary <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-01-22/prison_summary.csv")

prison_population <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-01-22/prison_population.csv")

combined_data <- readr::read_csv("https://raw.githubusercontent.com/5harad/openpolicing/master/results/data_for_figures/combined_data.csv")

data_quality <- readr::read_csv("https://raw.githubusercontent.com/5harad/openpolicing/master/results/data_for_figures/fig1_states_data_map.csv")

#Missouri <- readRDS("data/Missouri.rds")

Charlotte <- read_csv("/Users/ines/Documents/Master/2. Semester/Informationsvisualisierung Seminar/InfoVis_Abgabe/data/CharlotteUS.csv")

#Austin <- read_csv("data/Austin.csv")


library(ggplot2)
#install.packages("ggthemes")
library(ggthemes)
#install.packages("mapproj")
library(mapproj)
#install.packages("leaflet")
library(leaflet)
#install.packages("plotly")
library(plotly)
#install.packages("htmltools")
library("htmltools")
#install.packages("vembedr")
library("vembedr")
#install.packages("scales")
library("scales")
#install.packages("statebins")
library(statebins)
library(tidyverse)
library(lubridate)
#install.packages("lutz")
library(lutz)
#install.packages("suncalc")
library(suncalc)
#install.packages("splines")
library(splines)
```

### Intro in Problematik

```{r echo=FALSE}

plot_ly(
 x = c("White", "Black", "Hispanic", "Others"),
 y = c(66, 63, 33, 4),
 name = "Number of unarmed victims in police shootings in the US in 2015 by race",
 type = "bar"
)
```

***

Mehr als 60 Jahre nach Martin Luther Kings historischer „I have a Dream“-Speech spielen Rassismus, Rassenhass und Ungleichbehandlung immer noch eine alltägliche Rolle im Leben afroamerikanischer Bürger. Auffällig wird dies vor allem durch die oft willkürliche Gewalt weißer Polizeibeamter gegen Schwarze, die in den letzten Jahren vermehrt für mediale Aufmerksamkeit sorgte (vgl. Desmond et al., 2016). Bekannt wurden Dutzende Todesfälle unbewaffneter afroamerikanischer Bürger (z.B. Michael Brown oder Eric Garner) durch Schüsse weißer US-Polizisten. In vielen Fällen mussten sich die Täter nichtmals vor Gericht verantworten oder wurden freigesprochen (vgl. García & Sharif, 2015). Die Ereignisse führten zu der internationalen „Black Lives Matter“-Protestbewegung gegen Rassenungleichheit und weiße Polizeigewalt (vgl. Carney, 2016).

Bezug zu Abbildung in Text herstellen. Indiz für racias bias.

Informieren über Handhabung Website: plotly Funktionen etc.

### Text

```{r echo=FALSE}

raceUS <- c("White", "Black", "Hispanic", "Asian", "Other")
PopUS <- c(197000000, 40200000, 53900000, 16600000, 10470000)
NumberUS_df <- data.frame(raceUS, PopUS)
NumberUS_df <- data.frame("Categorie" =rownames(NumberUS_df), NumberUS_df)
NumberUS_df_ <- NumberUS_df[,c('Categorie')]
plot_ly(NumberUS_df, labels = ~raceUS, values = ~PopUS, type = 'pie', textposition = 'inside', textinfo = 'label+percent', insidetextfont = list(color = '#FFFFFF'), marker = list(colors = colors, line = list(color = '#FFFFFF', width = 1)), showlegend = FALSE) %>%
 layout(title = 'Racial Composition in the US in 2018 according to US Census',
        xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
        yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

```

***

Text zu Racial Composition in thr US in 2018. 

### Introduction {data-commentary-width=500}

```{r echo=FALSE}

embed_url("https://www.youtube.com/watch?time_continue=16&v=iwOWcuFjNfw") %>%
  use_start_time("0") %>%
  div(class = "vembedr", align = "center")
```

***

What is our aim?

Täglich führen Polizisten mehr als 50.000 Verkehrsstops in den USA durch. Trotz dieser hohen Zahl existiert keine systemtatische Aufzeichnung von Verkehrsstops. Um die Interaktion zwischen der Polizei und der Öffentlichkeit detailliert beschreiben und Unterschiede im Umgang mit verschiedenen Ethnien statistisch auswerten zu können, riefen Journalisten und Data Scientists der Stanford University das Stanford Open Policing Project 2015 ins Leben. Für unsere Untersuchungen nutzen wir die Daten des Stanford Open Policing Projects sowie Daten zu Incarceration Trends in den USA, zur Verfügung gestellt durch das Vera Institute of Justice. Aim: Wir wollen diese Daten explorieren und so mögliche racial bias sowohl im Polizeisystem als auch im Justizvollzugssystem systematisch untersuchen. Hierfür untersuchen werden stop rates, hit rates, arrest rates sowie incarceration trends in den USA untersucht. Diese large scale-analysis wollen wir verständlich für die Öffentlichkeit aufbereiten.

### Stanford Open Policing Project: What data will be used and how was it collected? or Which states shared police stop data with Stanford?

```{r echo=FALSE}
#install.packages("usmap")
library(usmap)
library(ggplot2)

q <- plot_usmap(data = data_quality, values = "status", lines = "white", labels = TRUE) +
    scale_fill_discrete(name = "Status") +
    labs(title = "Quality of Data Collected") +
    theme(legend.position = "right")

  ggplotly(q, tooltip = NULL)
```

***

Für das Stanford Open Policing Project wurden mehr als 100 Millionen Datensätze von staatlichen und lokalen Polizeidienststellen zu Verkehrsstops im ganzen Land gesammelt und standardisiert (vgl. Stanford Open Policing Project, 2015). Von den 50 Staaten der USA, stellten 31 ihre Daten für das Projekt zur Verfügung. Die restlichen 19 Staaten verfügten entweder über keine elektronische Erfassung der Daten oder sammelten keine Information zur race der Angehaltenen. Zudem haben einige Staaten gar nicht auf die Anfrage geantwortet, weshalb von diesen Staaten keine Daten vorliegen. Insgesamt stellten 31 Staaten Daten zur Verfügung die detailliert genug warem um racial disparities explorieren zu können. Das Wissen um die Qualität der Daten wurde bei der Auswahl der Datensätze für die folgenden Analysen genutzt und ist essentiell für die unverzerrte Interpretation der Visualisierungen.

### Racial Composition in Charlotte in 2018 

```{r echo=FALSE}

rrace <- c("White", "Black", "Hispanic", "Asian", "Other")
Ppop <- c(346000, 285000, 106000, 48300, 23800)
Number_df <- data.frame(rrace, Ppop)
Number_df <- data.frame("Categorie" =rownames(Number_df), Number_df)
Number_df_ <- Number_df[,c('Categorie')]
plot_ly(Number_df, labels = ~rrace, values = ~Ppop, type = 'pie', textposition = 'inside', textinfo = 'label+percent', insidetextfont = list(color = '#FFFFFF'), marker = list(colors = colors, line = list(color = '#FFFFFF', width = 1)), showlegend = FALSE) %>%
 layout(title = 'Racial Composition in Charlotte in 2018 according to US Census',
        xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
        yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))



```

***

Text zu : Racial Composition in Charlotte in 2018 und Proteste in Charlotte und daher Relevanz für Aufklärungskampagne.

### Are traffic stops in Charlotte prone to racial bias? {data-commentary-width=400}

```{r}
Charlotte_2 <- Charlotte %>% filter(type == "vehicular")
Charlotte_3 <- filter(Charlotte_2, year(date) > 2003)

Cha <- Charlotte_3 %>%
  count(year = year(date), subject_race) %>%
  ggplot(aes(x = year, y = n, color = subject_race)) +
  geom_point() +
  geom_line() +
  ggtitle("Stop Counts in Charlotte from 2004-2015") +
  xlab("year") +
  ylab("counts") + 
  theme_light()

ggplotly(Cha)

```

***

Im Jahr 2016 kam es in Charlotte im US-Bundesstaat North Carolina (NC) zu Demontrationen gegen Polizeigewalt sowie wiederholten Ausschreitungen nach dem Tod des Afroamerikaners Keith Lamont Scott durch einen Polizeibeamten. Aufgrund dieser Ereignisse sowie der hohen coverage rate (d.h. der Anteil der Daten, die Werte für eine bestimmte Variable enthalten) der dort erfassten Daten, wird in einem ersten Schritt die Häufigkeit betrachtet, nach der die Polizei in Charlotte bei verschiedenen ethnischen Gruppen Verkehrsstops durchgeführt hat. Folgende Variablen werden für die Analyse betrachtet: subject race, year und number of stops. 

Anhand der Visualisierung wird ersichtlich, dass Polizisten schwarze Fahrer häufiger anhalten als Weiße. According to Findings of Open Policing Project: 23 stops per 100 black driver and only 13 stops per 100 white drivers and 10 stops per 100 hispanic drivers. Außerdem weisen sowohl blacks als auch whites im Jahr 2010 die höchste stop rate vor.

Problematisch bei der Interpretation dieser Ergebnisse ist jedoch, dass die stop rate alleine nicht aussagekräftig genug ist, um auch racial bias zu schließen. So wird zum Beispiel nicht deutlich, was nach dem stop passiert ist. Außerdem sind Informationen über die Anteile der jeweiligen ethnischen Gruppen der Gesamtbevölkerung sowie generell eine kritische Betrachtung der Daten wichtig (benchmark test). Dennoch reicht auch diese Information noch nicht allein, da die gestoppen Person nicht auch zwangsläufig in dieser Stadt ansässig sind und es auch so zu Fehlinterpretationen kommen könnte.

### Number of arrest mades in Charlotte between 2004 and 2015

```{r echo=FALSE}

# Balkendiagramm: Number of arrest mades in Charlotte between 2004 and 2015


```

***

Text zu : Number of arrest mades in Charlotte between 2004 and 2015

### Are overall stop rates in the USA prone to racial bias?

```{r echo=FALSE}

st <- combined_data %>% group_by(driver_race) %>% summarise(total =  mean(stop_rate, na.rm = T)) %>% arrange(-total) %>% 
  ggplot() + aes(driver_race, total) + geom_col()

ggplotly(st)

#st <- ggplot(data = combined_data) +
 # aes(x = driver_race, weight = stop_rate) +
  #geom_bar(fill = '#7D7C79') +
  #theme_light() #hier eig den mean abbilden der stop rate?

#st + theme(axis.text.y = element_blank())

#TESTS
#combined_data %>%
 # filter(driver_race == "Black") %>%
  #summarize(meanStopRate = mean(stop_rate))

  #facet_grid(. ~ driver_race)

#View(combined_data)

```

***
The diagram emphazises the number of stops for black, hispanic and white drivers throughout the USA and gives an overview on first trends in stop rates. On the first glimpse, it is clearly visible that black drivers are to be stoped more than four times more likely than white drivers. Nevertheless, this outcome has to be viewed very critical for the same reasons as mentioned before. The data used for this visualization does not provide further information on the the reasons for the stop and neither on what happened after the stop. What was the reason for the stop? Was the driver searched for contraband (=illegal items) and if yes, was contraband found? Thus, it can not be said that with certainty that racial bias is the reason for the police stops. Therefore, different variables will be inspected in the upcoming analysis.

### After the stop: Are there racial disparities in the overall search rates?

```{r echo=FALSE}

search <- combined_data %>% group_by(driver_race) %>% summarise(total =  mean(search_rate, na.rm = T)) %>% arrange(-total) %>% 
  ggplot() + aes(driver_race, total) + geom_col() #+ coord_flip()

ggplotly(search)

#search <- ggplot(data = combined_data) +
 # aes(x = driver_race, weight = search_rate) +
  #geom_bar(fill = '#7D7C79') +
  #theme_light()

#search + theme(axis.text.y = element_blank())


#View(combined_data)

```

***

To further inspect if a police stop was conducted due to racial bias, it is necessary to explore whether black and hispanic drivers are also searched with a higher probability to get an insight into what happens after the stop. The diagram shows that hispanic drivers are almost as likely to be searched for counterband (e.g. drugs or weapons) as black drivers and white drivers only half likely to be searched. Nevertheless, we are still lacking information on if the stop was justified. Did the police find for example drugs or weapons (hit rate)? Because if so, then there are no racial disparities present but appropiate police work. The task to differ discrimination from effective police work is highly challenging and therefore a closer look on the hit rate will be conducted next.

### How often was contraband found?

```{r echo=FALSE}

hit <- combined_data %>% group_by(driver_race) %>% summarise(total =  mean(hit_rate, na.rm = T)) %>% arrange(-total) %>% 
  ggplot() + aes(driver_race, total) + geom_col()

ggplotly(hit)

#hit <- ggplot(data = combined_data) +
 # aes(x = driver_race, weight = hit_rate) +
  #geom_bar(fill = '#7D7C79') +
  #theme_light()

#hit + theme(axis.text.y = element_blank())


#View(combined_data)

```

***

As shown before, stopped black and Hispanic drivers are searched more often than whites. But if minorities also happen to carry contraband at higher rates, these higher search rates may stem from appropriate police work. Therefore, a closer look at the search outcome is necessary to detect whether a stop was justified or due to racial bias. If the contraband (for example drugs or weapons) are found with a similar relation as to the stop rate, there is no discrimination.

The diagrams shows that although black and hispanic drivers are stopped and searched more often than white drivers, contraband such as drugs or weapons have not been found quiet as often. This outcome indicates that black and hispanic drivers are stopped with less evidence of wrongdoing. On the other hand, white drivers are searched less often but are more likely to be found with contraband. Also hispanics are searched on the basis of less evidence than whites. We still do not know if officers knowingly engaged in racial discrimination which is why this outcome has to be treated again with care. Nonetheless, the data hints to the conclusion that race plays a role for stops made by american police officers. 

### After the stop: How many arrests were made by police officers?

```{r}

arrest <- combined_data %>% group_by(driver_race) %>% summarise(total =  mean(arrest_rate, na.rm = T)) %>% arrange(-total) %>% 
  ggplot() + aes(driver_race, total) + geom_col()

ggplotly(arrest)

#combined_data %>% group_by(driver_race, state, location) %>% summarise(total =  mean(arrest_rate, na.rm = T)) %>% arrange(-total)

#arrest + theme(axis.text.y = element_blank())

```

***

Before having a closer look on the incarceration trends and possible racial bias in the criminal justice system in the USA, it is interesting to examine the arrest rates that were conducted by the police officers after the stop. 

The diagram shows that hispanic drivers are arrested most often, followed by black driver. White drivers are only half as likely to be arrested than hispanics. 

### Incarceration: Trends in Black and White Jail Incarceration in 2015

```{r echo=FALSE}
#Visualisierungen prison_population
# 1. explore data


prison_pop_by_region <-  prison_population %>% 
  count(region, sort = TRUE)

# Note: some states are fully missing data, e.g. Arizona. Why is that so? And what data are we missing?
# 2015 most recent year available with data

prison_population_2015 <- prison_population %>%
  filter(year == 2015)

prision_pop_by_state <- prison_population_2015 %>%
  group_by(state) %>%
  filter(any(!is.na(prison_population))) %>%
  count(state) # we only have data from 29 states 

prison_pop_by_state_avg <- prison_population_2015 %>%
  group_by(state) %>%
  filter(any(!is.na(prison_population))) %>%
  summarize(mean(is.na(prison_population))) # we are missing 14
if(FALSE){
# Are we more likely to be missing data from smaller counties? maybe they dont have their own prisons? or because they dont have data?
prison_population_2015 %>%
  group_by(state) %>%
  filter(any(!is.na(prison_population))) %>%
  ungroup() %>% 
  filter(prison_population == 0) # there is prison population that equals zero, the n/a's are probably not zero but missing data

prison_population_2015 %>%
  filter(!is.na(population)) %>%
  group_by(state) %>%
  filter(any(!is.na(prison_population))) %>%
  ungroup() %>% 
  group_by(state) %>%
  summarize(total_pop_missing_prison = sum(population[is.na(prison_population)]) / sum(population)) %>%
  arrange(desc(total_pop_missing_prison)) # shows that e.g. in North Dakota we are missing 11 % of peole living in the county where we dont have the prison data. In most states we are missing only a few percent of the population

}
# Missing states
non_missing_states <- prison_population_2015 %>%
  filter(!is.na(population)) %>%
  group_by(state) %>%
  filter(any(!is.na(prison_population))) %>%
  ungroup() 

if(FALSE){ 
  non_missing_states %>%
  group_by(state) %>%
  summarize(total_pop_missing_prison = sum(population[is.na(prison_population)]) / sum(population)) %>%
  arrange(desc(total_pop_missing_prison))
  
 non_missing_states %>%
    group_by(population_category = cut(population, c(-1, 10, 100, 1000, 10000, Inf))) %>%
    summarize(pct_missing = mean(is.na(prison_population)),
              observations = n()) # we are missing data everywhere in the low population counties, but for the high population counties we almost always have the data
}

by_state <- non_missing_states %>%
  filter(!is.na(prison_population),
         pop_category == "Total") %>%
  group_by(state) %>%
  summarize_at(vars(population, prison_population), sum) %>%
  mutate(incarceration_rate = prison_population / population) %>%
  arrange(desc(incarceration_rate)) # 29 states
# the incarceration never goes over 1% and highest rate in Arizona

# Map mit einzelnen counties (2015)
mdata <- map_data("county") %>%
  tbl_df()

county_overall_2015 <- prison_population_2015 %>%
  filter(pop_category == "Total") %>%
  mutate(region = str_to_lower(state.name[match(state, state.abb)]),
         subregion = str_remove(str_to_lower(county_name), "county| parish| city"), 
         incarceration_rate = prison_population / population)

q2 <- county_overall_2015 %>%
  filter(incarceration_rate < .05) %>% 
  mutate(subregion = str_remove(subregion, " ")) %>% 
  right_join(mdata, by = c("region", "subregion")) %>% 
  ggplot(aes(long, lat, group = group, fill = incarceration_rate)) +
  geom_polygon() +
  ggtitle("Incarceration Rate throughout the USA in 2015") +
  theme_map() +
  coord_map() +
  scale_fill_gradient2(low = "green", high = "red", midpoint = .01,
                       labels = scales::percent_format()) +
  theme(legend.position = "right")
  

print(q2)

#install.packages("dygraphs")
#ggplotly(q2,  tooltip = NULL) # klappt nicht mit plotly beim knitten


```

***

Neben der amerikanischen Polizeiarbeit ist auch das Rechts- und Strafvollzugswesen von Rassismus und Diskriminierung durchzogen. Ergebnisse verschiedener Studien zufolge werden Schwarze immer noch mit einer  3,6 x höheren Wahrscheinlichkeit inhaftiert als Weiße (vgl. Vera Institute of Justice, 2015).

Der Datensatz “Incarceration Trends”, der im Dezember 2015 vom Vera Institute of Justice herausgebracht wurde, setzt sich zum Ziel, eine mögliche Rassendiskriminierung in US-Gefängnissen systematisch zu untersuchen. In der Abbildung zu sehen sind die incarceration rates aller US-Counties. Auch hier wird wieder die große Anzahl an missing data deutlich, vor allem im Norden der USA. In Texas liegen die höchsten incarceration rates vor. 


### Does urbanicity play a role for the incarceration rate for different races?

```{r}

pr <- prison_summary %>%
  filter(pop_category %in% c("White", "Black", "Asian", "Latino")) %>%
  ggplot(aes(year, rate_per_100000, color = urbanicity)) +
  geom_line() +
  ggtitle("Closer Inspection on Urbanicity and Race") +
  facet_wrap(~ pop_category) +
  theme_light() + 
  labs(x = "Year",
       y = "Rate per 100000",
       color = "Urbanicity") +
  scale_color_colorblind()

#pr

ggplotly(pr)

#add source with caption?

# vielleicht nocht was allgemeines mit bezug auf race und incarceration?
```

***

The diagram shows that the incarceration rates vary between the races and are highest for the black population. The urbanicity does not seem to play a significant role since they show similar results for rural, small/mid, suburban as well as urban areas. Only the suburban black population shows lower incarcerations rates but is still a lot higher than for other ethnicities. 

### Sources

```{r}

```

***

- E. Pierson, C. Simoiu, J. Overgoor, S. Corbett-Davies, D. Jenson, A. Shoemaker, V. Ramachandran, P. Barghouty, C. Phillips, R. Shroff, and S. Goel. (2019) “A large-scale analysis of racial disparities in police stops across the United States”.
- https://github.com/stanford-policylab/opp/blob/master/data_readme.md -> Zur Entscheidung welche Daten brauchbar herangezogen
- https://www.nbcnews.com/news/us-news/inside-100-million-police-traffic-stops-new-evidence-racial-bias-n980556
- https://www.vera.org/publications/divided-justice-black-white-jail-incarceration
