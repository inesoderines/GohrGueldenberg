---
title: "Law Enforcement in the USA"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    css: style.css
---
```{r}
#Load Data and Libraries

library(flexdashboard)

library(tidyverse)

theme_set(theme_light())

prison_summary <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-01-22/prison_summary.csv")

prison_population <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-01-22/prison_population.csv")

combined_data <- readr::read_csv("https://raw.githubusercontent.com/5harad/openpolicing/master/results/data_for_figures/combined_data.csv")

data_quality <- readr::read_csv("https://raw.githubusercontent.com/5harad/openpolicing/master/results/data_for_figures/fig1_states_data_map.csv")

library(ggplot2)
#install.packages("ggthemes")
library(ggthemes)
#install.packages("mapproj")
library(mapproj)
#install.packages("leaflet")
library(leaflet)
#install.packages("plotly")
library(plotly)
#install.packages("htmltools")
library("htmltools")
#install.packages("vembedr")
library("vembedr")
#install.packages("scales")
library("scales")
#install.packages("statebins")
library(statebins)

```

### Stanford Open Policing Project {data-commentary-width=400}

```{r echo=FALSE}

# Platzhalter map mit police stops und no data states oder Youtube Video https://www.youtube.com/watch?time_continue=16&v=iwOWcuFjNfw

embed_url("https://www.youtube.com/watch?time_continue=16&v=iwOWcuFjNfw") %>%
  use_start_time("0") %>%
  div(class = "vembedr", align = "center")
```

***

Introduction:

Mehr als 60 Jahre nach Martin Luther Kings historischer „I have a Dream“-Speech spielen Rassismus, Rassenhass und Ungleichbehandlung immer noch eine alltägliche Rolle im Leben afroamerikanischer Bürger. Auffällig wird dies vor allem durch die oft willkürliche Gewalt weißer Polizeibeamter gegen Schwarze, die in den letzten Jahren vermehrt für mediale Aufmerksamkeit sorgte. Bekannt wurden Dutzende Todesfälle unbewaffneter afroamerikanischer Bürger (z.B. Michael Brown, Eric Garner oder Walter Scott) durch Schüsse weißer Polizisten, die zu landesweiten Massenprotesten führten sowie in der Protestbewegung „Black Lives Matter“ mündeten. 


### Quality of Data provided by States to the Stanford Open Policing Project 

```{r echo=FALSE}

# Platzhalter map mit police stops und no data states 


# neeext: klappt aber möchte noch state name angezeigt bekommen
#install.packages("usmap")
library(usmap)
library(ggplot2)

  q <- plot_usmap(data = data_quality, values = "status", lines = "white") +
    scale_fill_excel_new(name = "Status of data quality") +
    labs(title = "Quality of Data") +
    theme(legend.position = "right")
  
  ggplotly(q, tooltip = NULL)


```

***

Das Stanford Open Policing Project:

Täglich führen Polizisten mehr als 50.000 Verkehrsstops in den USA durch (jährlich beträgt dies mehr als 20 Millionen Autofahrer). Trotz dieser hohen Zahl existiert keine systemtatische Aufzeichnung von Verkehrsstops. Um die Interaktion zwischen der Polizei und der Öffentlichkeit detailliert beschreiben und Unterschiede im Umgang mit verschiedenen Ethnien statistisch auswerten zu können, riefen Journalisten und Data Scientists der Stanford University das Stanford Open Policing Project 2015 ins Leben. Es wurden mehr als 200 Millionen Datensätze von staatlichen und lokalen Polizeidienststellen zu Verkehrsstops im ganzen Land gesammelt und standardisiert. 

Als Herausforderung zeigte sich, dass einige Staaten keine Daten zu Verkehrsstops sammeln und andere die Informationen nicht herausgeben. Selbst bei Staaten, die die Daten freigegeben haben, unterscheidet sich die Datenerhebung zum Teil enorm, was die Standardisierung der Informationen erschwert. Angesichts der großen Datenmenge lassen sich aber dennoch statistische Analysen durchführen. 


### Stop Rates {data-commentary-width=400}

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Platzhalter mit Diagrammen zu Stop rates der 6 ausgewählten Städte. Abgebildet wird: subject race 


```

***

Stop rates:

Zunächst wird die Häufigkeit betrachtet, nach der die Polizei in diversen US-amerikanischen Städten bei verschiedenen ethnischen Gruppen Verkehrsstops durchgeführt hat. 
Die Wahl der untersuchten Städte richtete sich nach der Quantität der erhobenen Daten, der Vollständigkeit der Datensätze sowie den jeweiligen Gebieten erhobenen Faktoren. Für die Analysezwecke waren die Variablen “date”, “subject race”, “arrest made” und “stop rate” ausschlaggebend. Um das Risiko von Verzerrungen in der Vergleichbarkeit der Städte zu senken wurde zudem darauf geachtet, dass die jeweilige “coverage rate” (d.h. der Anteil der Daten, die Werte für eine bestimmte Variable enthalten) mehr als 80% beträgt. Die in der Analyse betrachteten Städte sind: San Francisco (CA), New Orleans, Mesa , Charlotte (NC), Columbus (NE), Philadelphia (PE)


### Search Rate: ALS FRAGEN FORMULIEREN IN DIESEN FELDERN?

```{r echo=FALSE}

# Platzhalter: Diagramm zu search rates in den 6 Städten

```

***

Comments about Frame 3

### Hit Rate

```{r echo=FALSE}

```

***

Comments about Frame 4

### Arrest Made

```{r}

```

***

Comments about Frame 5: Hier den Übergang zu Incarceration darstellen

### Incarceration: Trends in Black and White Jail Incarceration 

```{r echo=FALSE}
#Visualisierungen prison_population
# 1. explore data


prison_pop_by_region <-  prison_population %>% 
  count(region, sort = TRUE)

# Note: some states are fully missing data, e.g. Arizona. Why is that so? And what data are we missing?
# 2015 most recent year available with data

prison_population_2015 <- prison_population %>%
  filter(year == 2015)

prision_pop_by_state <- prison_population_2015 %>%
  group_by(state) %>%
  filter(any(!is.na(prison_population))) %>%
  count(state) # we only have data from 29 states 

prison_pop_by_state_avg <- prison_population_2015 %>%
  group_by(state) %>%
  filter(any(!is.na(prison_population))) %>%
  summarize(mean(is.na(prison_population))) # we are missing 14
if(FALSE){
# Are we more likely to be missing data from smaller counties? maybe they dont have their own prisons? or because they dont have data?
prison_population_2015 %>%
  group_by(state) %>%
  filter(any(!is.na(prison_population))) %>%
  ungroup() %>% 
  filter(prison_population == 0) # there is prison population that equals zero, the n/a's are probably not zero but missing data

prison_population_2015 %>%
  filter(!is.na(population)) %>%
  group_by(state) %>%
  filter(any(!is.na(prison_population))) %>%
  ungroup() %>% 
  group_by(state) %>%
  summarize(total_pop_missing_prison = sum(population[is.na(prison_population)]) / sum(population)) %>%
  arrange(desc(total_pop_missing_prison)) # shows that e.g. in North Dakota we are missing 11 % of peole living in the county where we dont have the prison data. In most states we are missing only a few percent of the population

}
# Missing states
non_missing_states <- prison_population_2015 %>%
  filter(!is.na(population)) %>%
  group_by(state) %>%
  filter(any(!is.na(prison_population))) %>%
  ungroup() 

if(FALSE){ 
  non_missing_states %>%
  group_by(state) %>%
  summarize(total_pop_missing_prison = sum(population[is.na(prison_population)]) / sum(population)) %>%
  arrange(desc(total_pop_missing_prison))
  
 non_missing_states %>%
    group_by(population_category = cut(population, c(-1, 10, 100, 1000, 10000, Inf))) %>%
    summarize(pct_missing = mean(is.na(prison_population)),
              observations = n()) # we are missing data everywhere in the low population counties, but for the high population counties we almost always have the data
}

by_state <- non_missing_states %>%
  filter(!is.na(prison_population),
         pop_category == "Total") %>%
  group_by(state) %>%
  summarize_at(vars(population, prison_population), sum) %>%
  mutate(incarceration_rate = prison_population / population) %>%
  arrange(desc(incarceration_rate)) # 29 states
# the incarceration never goes over 1% and highest rate in Arizona

# add the colum state_name to get full names of states and not only abbreviations 
#by_state %>%
  #mutate(region = str_to_lower(state.name[match(state, state.abb)]))  %>%
  #right_join(map_data("state"), by = "region") %>%
  #ggplot(aes(long, lat, group = group, fill = incarceration_rate)) +
  #geom_polygon() +
  #theme_map() + 
  #coord_map() # incarceration rate varies a lot and there are states espacially in the north that are missing data

# Farben zeigen wie stark 
#by_state %>%
  #mutate(region = str_to_lower(state.name[match(state, state.abb)]))  %>%
  #right_join(map_data("state"), by = "region") %>%
  #ggplot(aes(long, lat, group = group, fill = incarceration_rate)) +
  #geom_polygon() +
  #theme_map() + 
  #coord_map() + 
  #scale_fill_gradient2(low = "blue", high = "red", midpoint = .01, 
                       #labels = scales::percent_format())

#map_data("state") %>%
  #tbl_df()

# Map mit einzelnen counties (2015)
mdata <- map_data("county") %>%
  tbl_df()

county_overall_2015 <- prison_population_2015 %>%
  filter(pop_category == "Total") %>%
  mutate(region = str_to_lower(state.name[match(state, state.abb)]),
         subregion = str_remove(str_to_lower(county_name), "county| parish| city"), 
         incarceration_rate = prison_population / population)

q2 <- county_overall_2015 %>%
  filter(incarceration_rate < .05) %>% 
  mutate(subregion = str_remove(subregion, " ")) %>% 
  right_join(mdata, by = c("subregion", "subregion")) %>% 
  ggplot(aes(long, lat, group = group, fill = incarceration_rate)) +
  geom_polygon() +
  ggtitle("Incarceration Rate throughout the USA in 2015") +
  theme_map() +
  coord_map() +
  scale_fill_gradient(low = "blue", high = "red", 
                       labels = scales::percent_format()) +
  theme(legend.position = "right")
  

print(q2)

#install.packages("dygraphs")


#ggplotly(q2) # klappt nicht mit plotly

# was mit gganimate machen?vielleicht bei stop rate etc?
```

***

Neben der amerikanischen Polizeiarbeit ist auch das Rechts- und Strafvollzugswesen von Rassismus und Diskriminierung durchzogen. Ergebnisse verschiedener Studien zufolge werden Schwarze immer noch mit einer  3,6 x höheren Wahrscheinlichkeit inhaftiert als Weiße. (https://www.vera.org/publications/divided-justice-black-white-jail-incarceration)

Der Datensatz “Incarceration Trends”, der im Dezember 2015 vom Vera Institute of Justice herausgebracht wurde, setzt sich zum Ziel, eine mögliche Rassendiskriminierung in US-Gefängnissen systematisch zu untersuchen. 


### Incarceration Trends: Urbanicity and Race 

```{r}

p <- prison_summary %>%
  filter(pop_category %in% c("White", "Black", "Asian", "Latino")) %>%
  ggplot(aes(year, rate_per_100000, color = urbanicity)) +
  geom_line() +
  ggtitle("Closer Inspection on Urbanicity and Race") +
  facet_wrap(~ pop_category) +
  theme_light() + 
  labs(x = "Year",
       y = "Rate per 100000",
       color = "Urbanicity") +
  scale_color_colorblind()

p

ggplotly(p)

#add spurce with caption?
```

***

Question: Does urbanicity play a role for the incarceration rate? There is a variation between the races but the urbanicity does not seem to play a role... 


### Sources
```{r}
# vielleicht auch links für further information einbauen?

```

***

- E. Pierson, C. Simoiu, J. Overgoor, S. Corbett-Davies, D. Jenson, A. Shoemaker, V. Ramachandran, P. Barghouty, C. Phillips, R. Shroff, and S. Goel. (2019) “A large-scale analysis of racial disparities in police stops across the United States”.
- https://github.com/stanford-policylab/opp/blob/master/data_readme.md -> Zur Entscheidung welche Daten brauchbar herangezogen

